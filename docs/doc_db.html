<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <title>CodeLapse\Database</title>
    <script src="/CodeLapse/static/js/jquery.min.js"></script>
    <script src="/CodeLapse/static/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="/CodeLapse/static/css/highlight.github.css">
    <link rel="stylesheet" href="/CodeLapse/static/css/style.css">
  </head>

  <body>
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container"><a href="/CodeLapse/" class="navbar-brand">CodeLapse Docs</a>
        <div class="navbar-right">
          <div class="collapse navbar-collapse">
            <ul class="nav navbar-nav">
              <li><a href="/CodeLapse/apidocs/namespaces/CodeLapse.html">API Docs</a></li>
              <li><a href="https://github.com/ucym/CodeLapse">GitHub</a></li>
            </ul>
          </div>
        </div>
      </div>
    </nav>
    <div id="content" class="container">
      <div class="row">
        <div class="col-xs-3">
          <div data-spy="affix" data-offset-top="0" affix class="doc-nav">
            <ul class="nav">
              <li><a href="/CodeLapse/">Docs</a></li>
              <li class="doc-nav-item_label">機能</li>
              <li><a href="/CodeLapse/docs/doc_array.html">Arr</a><a href="/CodeLapse/docs/doc_form.html">Form</a><a href="/CodeLapse/docs/doc_db.html">Database<span class="text-muted">&nbsp;as DB</span></a><a href="/CodeLapse/docs/doc_request.html">Request<span class="text-muted">&nbsp;as Req</span></a></li>
            </ul>
          </div>
        </div>
        <div class="col-xs-9">
          <article>
            <h1 class="page-header">Database<small class="class-name-alias">as DB</small><a href="/CodeLapse/apidocs/classes/CodeLapse.DB.html" class="doc-header_api-link glyphicon glyphicon-link"></a></h1>
            <p>DBクラスはデータベースへ接続ヘルパーです。
              <br> mysql_*関数, PDOをサポートしており、統一されたインターフェースでデータベースを扱うことができます。</p>
            <h3 class="page-header">設定</h3>
            <p><code>/cl/config/db.php</code>に接続設定を記述します。
              <br><code>default</code>コネクションがDBクラスで利用する通常のコネクションになります。</p><pre><code class="lang-php"><span class="php"><span class="hljs-preprocessor">&lt;?php</span>
<span class="hljs-keyword">return</span> <span class="hljs-keyword">array</span>(
    <span class="hljs-comment">// defaultコネクションの設定</span>
    <span class="hljs-string">'default'</span> =&gt; <span class="hljs-keyword">array</span>(
        <span class="hljs-string">'user'</span>      =&gt; <span class="hljs-string">'dbuser'</span>,
        <span class="hljs-string">'password'</span>  =&gt; <span class="hljs-string">'dbpass'</span>,
        <span class="hljs-string">'host'</span>      =&gt; <span class="hljs-string">'localhost'</span>,

        <span class="hljs-comment">// ここ以下は設定しなくてもよいですが</span>
        <span class="hljs-comment">// 設定されていた場合、自動的に"use"と"set name"クエリが実行されます。</span>
        <span class="hljs-string">'database'</span>  =&gt; <span class="hljs-string">'dbname'</span>,
        <span class="hljs-string">'charset'</span>   =&gt; <span class="hljs-string">'utf8'</span>
    )
)</span>
</code></pre>
            <h3 class="page-header">利用例</h3>
            <p>以下はシンプルなログイン処理の実装例です。
              <br><code>DB::queryメソッド</code>でプレースホルダが利用できるのを確認できます。</p><pre><code class="lang-php"><span class="php"><span class="hljs-preprocessor">&lt;?php</span>
<span class="hljs-keyword">if</span> (Req::method() === <span class="hljs-string">"POST"</span>) {
    <span class="hljs-variable">$user_id</span> = Req::post(<span class="hljs-string">'user_id'</span>);
    <span class="hljs-variable">$password</span> = Req::post(<span class="hljs-string">'password'</span>);

    <span class="hljs-comment">// パスワードパッシュを取得する</span>
    <span class="hljs-variable">$resultset</span> = DB::query(<span class="hljs-string">'SELECT `password` FROM `users` WHERE `user_id` = :user_id'</span>, <span class="hljs-keyword">array</span>(
        <span class="hljs-string">':user_id'</span> =&gt; <span class="hljs-variable">$user_id</span>
    ));

    <span class="hljs-variable">$password_hash</span> = Arr::get(<span class="hljs-variable">$resultset</span>-&gt;fetch(), <span class="hljs-string">'password'</span>);

    <span class="hljs-keyword">if</span> (password_verify(<span class="hljs-variable">$password</span>, <span class="hljs-variable">$password_hash</span>)) {
        header(<span class="hljs-string">'Redirect: hello.php'</span>);
        <span class="hljs-keyword">exit</span>;
    }
    <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">echo</span> <span class="hljs-string">'ユーザー名かパスワードが間違っています。'</span>;
    }
}
<span class="hljs-preprocessor">?&gt;</span></span>
<span class="hljs-tag">&lt;<span class="hljs-title">form</span> <span class="hljs-attribute">method</span>=<span class="hljs-value">"post"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">label</span>&gt;</span>ユーザーID <span class="hljs-tag">&lt;<span class="hljs-title">input</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"text"</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"user_id"</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"form-input"</span> /&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">label</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">label</span>&gt;</span>パスワード <span class="hljs-tag">&lt;<span class="hljs-title">input</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"password"</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"password"</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"form-input"</span> /&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">label</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-title">button</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"btn btn-primary"</span>&gt;</span>ログイン<span class="hljs-tag">&lt;/<span class="hljs-title">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">form</span>&gt;</span>
</code></pre>
            <h3 class="page-header">API</h3>
            <ul>
              <li><a href="/CodeLapse/apidocs/classes/CodeLapse.DB.html">DBクラス</a></li>
              <li><a href="/CodeLapse/apidocs/namespaces/CodeLapse.Database.html">CodeLapse\Database名前空間（DBクラスの処理の移譲先クラス群）</a></li>
            </ul>
          </article>
        </div>
      </div>
    </div>
    <script>
      (function(i, s, o, g, r, a, m)
      {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function()
        {
          (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
        a = s.createElement(o),
          m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m)
      })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
      ga('create', 'UA-64825163-1', 'auto');
      ga('send', 'pageview');
    </script>
  </body>

</html>